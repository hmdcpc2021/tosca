# Inputs removed

tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - https://raw.githubusercontent.com/micado-scale/tosca/v0.9.0/micado_types.yaml

repositories:
  docker_hub: https://hub.docker.com/

description: ADT for Sleep Healthcare & SSE Scheme Deployment on EC2

dsl_definitions:
  compute_cloud: &compute_cloud
    type: tosca.nodes.MiCADO.EC2.Compute
    properties:
      region_name: ADD_YOUR_REGION_NAME_HERE (e.g. eu-west-1)
      image_id: ADD_YOUR_IMAGE_ID_HERE (e.g. ami-061a2d878e5754b62)
      instance_type: ADD_INSTANCE_TYPE_HERE (e.g. t2.small)
      security_group_ids:
        - ADD_YOUR_SECURITY_GROUP_ID_HERE (e.g. sg-93d46bf7)
      key_name: -OPTIONAL- ADD_YOUR_KEY_NAME_HERE (e.g. my_ssh_key)
    interfaces:
      Occopus:
        create:
          inputs:
            endpoint: https://ec2.eu-west-2.amazonaws.com

  compute_cloud_with_nfs: &compute_cloud_with_nfs
    type: tosca.nodes.MiCADO.EC2.Compute
    properties:
      region_name: ADD_YOUR_REGION_NAME_HERE (e.g. eu-west-1)
      image_id: ADD_YOUR_IMAGE_ID_HERE (e.g. ami-061a2d878e5754b62)
      instance_type: ADD_INSTANCE_TYPE_HERE (e.g. t2.small)
      security_group_ids:
        - ADD_YOUR_SECURITY_GROUP_ID_HERE (e.g. sg-93d46bf7)
      key_name: -OPTIONAL- ADD_YOUR_KEY_NAME_HERE (e.g. my_ssh_key)
      context:
        insert: true
        cloud_config: |
          runcmd:
          - apt-get install -y nfs-common
    interfaces:
      Occopus:
        create:
          inputs:
            endpoint: https://ec2.eu-west-2.amazonaws.com

topology_template:
  node_templates:

    # Describe the Sleep Healthcare application containers
    xnat:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: somnonetz/snet-xnat
        env:
        - name: XNAT_ROOT
          value: /data/xnat
        - name: XNAT_HOME
          value: /data/xnat/home
        - name: XNAT_DATASOURCE_DRIVER
          value: org.postgresql.Driver
        - name: XNAT_DATASOURCE_URL
          value: jdbc:postgresql://xnat-db/xnat
        - name: XNAT_DATASOURCE_USERNAME
          value: xnat
        - name: XNAT_DATASOURCE_PASSWORD
          value: ADD_YOUR_XNAT_DB_PASSWORD_HERE
        - name: XNAT_HIBERNATE_DIALECT
          value: org.hibernate.dialect.PostgreSQL9Dialect
        - name: TOMCAT_XNAT_FOLDER
          value: xnat
        - name: CATALINA_OPTS
          value: -Xms128m -Xmx2048m -Dxnat.home=/data/xnat/home -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8000
        - name: PGPASSWORD
          value: ADD_YOUR_XNAT_DB_PASSWORD_HERE
        ports:
        - target: 8080 
        - containerPort: 8080
      requirements:
      - host: sleep-app-server
      - volume:
          node: xnat-logs-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /data/xnat/home/logs
      - volume:
          node: xnat-archive-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /data/xnat/archive
      - volume:
          node: xnat-build-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /data/xnat/build
      - volume: docker-socket-vol

    xnat-db:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: postgres:9.4-alpine
        env:
          - name: POSTGRES_USER
            value: xnat
          - name: POSTGRES_PASSWORD
            value: ADD_YOUR_XNAT_DB_PASSWORD_HERE
          - name: POSTGRES_DB
            value: xnat
        ports:
        - target: 5432
        - containerPort: 5432
      requirements:
      - host: sleep-app-server
      - volume: 
          node: xnat-db-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /var/lib/postgresql/data

    nginx:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: somnonetz/snet-nginx
        env:
          - name: XNAT_API_URL
            value: https://xnat.snet-apps.com/xnat/REST
          - name: SSE_SERVER_BASE_URL
            value: https://sse.snet-apps.com
          - name: TA_BASE_URL
            value: https://ta.snet-apps.com
          - name: SALT_VALUE
            value: abc123!?
          - name: IV_VALUE
            value: abcdefg
        ports:
        - containerPort: 80
          hostPort: 80
        - containerPort: 443
          hostPort: 443
      requirements:
      - host: sleep-app-server
      - volume:
          node: certbot-conf-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /etc/letsencrypt
      - volume:
          node: certbot-www-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /var/www/certbot
      - volume: 
          node: nginx-conf-vol
          relationship:
            type: tosca.relationships.AttachesTo
            properties:
              location: /etc/nginx/conf.d

    # certbot:
    #   type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
    #   properties:
    #     image: certbot/certbot
    #   requirements:
    #   - host: sleep-app-server
    #   - volume:
    #       node: certbot-conf-vol
    #       relationship:
    #         type: tosca.relationships.AttachesTo
    #         properties:
    #           location: /etc/letsencrypt
    #   - volume:
    #       node: certbot-www-vol
    #       relationship:
    #         type: tosca.relationships.AttachesTo
    #         properties:
    #           location: /var/www/certbot

    # Describe volumes
    xnat-logs-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/xnat/logs
    xnat-archive-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/xnat/archive
    xnat-build-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/xnat/build
    xnat-db-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/xnat-db
    nginx-conf-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/nginx/conf.d
    certbot-conf-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/certbot/conf
    certbot-www-vol:
      type: tosca.nodes.MiCADO.Container.Volume.NFS
      properties:
        server: 172.31.24.144
        path: /home/ubuntu/nfs/certbot/www
    docker-socket-vol:
      type: tosca.nodes.MiCADO.Container.Volume.HostPath
      properties:
        path: /var/run/docker.sock


    # Describe the SSE containers
    sse:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: uowcpc/asclepios-server:dev
        ports:
        - target: 8080
          nodePort: 30808
        env:
        - name: DJANGO_LOGLEVEL
          value: DEBUG
        - name: TA_SERVER
          value: "http://ta:8000"
        - name: DB_NAME
          value: sse-db
        - name: DB_USER
          value: sse
        - name: DB_PASSWORD
          value: sse
        - name: DB_HOST
          value: sse-db
        - name: DB_PORT
          value: "5432"
        - name: ALLOWED_HOSTS
          value: "*"
        - name: DJANGO_DEBUG
          value: "true"
      requirements:
      - host: sse-server

    sse-db:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: postgres
        ports:
        - target: 5432
        env:
        - name: POSTGRES_USER 
          value: sse
        - name: POSTGRES_PASSWORD 
          value: sse
        - name: POSTGRES_DB
          value: sse-db
        - name: PGDATA
          value: /var/lib/postgresql/data
      requirements:
      - host: sse-server

    # Describe the TA containers
    ta:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: uowcpc/asclepios-ta:dev
        ports:
        - target: 8000
        env:
        - name: DJANGO_LOGLEVEL
          value: DEBUG
        - name: DB_NAME
          value: ta-db
        - name: DB_USER
          value: ta
        - name: DB_PASSWORD
          value: ta
        - name: DB_HOST
          value: ta-db 
        - name: DB_PORT
          value: "5432"
        - name: ALLOWED_HOSTS
          value: "*"
        - name: HASH_LENGTH
          value: "256"
        - name: KEY_G
          value: "123"
        - name: SALT
          value: abc123!?
        - name: IV
          value: abcdefg
        - name: DJANGO_DEBUG
          value: "true"
      requirements:
      - host: ta-server

    ta-db:
      type: tosca.nodes.MiCADO.Container.Application.Docker.Deployment
      properties:
        image: postgres
        ports:
        - target: 5432
        env:
        - name: POSTGRES_USER 
          value: ta
        - name: POSTGRES_PASSWORD 
          value: ta
        - name: POSTGRES_DB
          value: ta-db
        - name: PGDATA
          value: /var/lib/postgresql/data
      requirements:
      - host: ta-server

    # Describe server VMs
    sleep-app-server: *compute_cloud_with_nfs
    sse-server: *compute_cloud
    ta-server: *compute_cloud
      
  policies:
  - monitoring:
      type: tosca.policies.Monitoring.MiCADO
      properties:
        enable_container_metrics: true
        enable_node_metrics: true